<svg viewBox="0 0 672 720" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <filter id="roughen" x="-2%" y="-2%" width="104%" height="104%">
      <feTurbulence type="turbulence" baseFrequency="0.03" numOctaves="2" result="noise" seed="42"/>
      <feDisplacementMap in="SourceGraphic" in2="noise" scale="1.1" xChannelSelector="R" yChannelSelector="G"/>
    </filter>
    <filter id="glow">
      <feGaussianBlur stdDeviation="3" result="blur"/>
      <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
    <marker id="arr" viewBox="0 0 12 10" refX="10" refY="5"
            markerWidth="8" markerHeight="6" orient="auto-start-reverse"
            fill="none" stroke="#e0e0e0" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
      <path d="M 1,1 L 10,5 L 1,9"/>
    </marker>
    <marker id="arr-purple" viewBox="0 0 12 10" refX="10" refY="5"
            markerWidth="8" markerHeight="6" orient="auto-start-reverse"
            fill="none" stroke="rgb(168,85,247)" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
      <path d="M 1,1 L 10,5 L 1,9"/>
    </marker>
    <marker id="arr-muted" viewBox="0 0 12 10" refX="10" refY="5"
            markerWidth="8" markerHeight="6" orient="auto-start-reverse"
            fill="none" stroke="#888888" stroke-width="1.5"
            stroke-linecap="round" stroke-linejoin="round">
      <path d="M 1,1 L 10,5 L 1,9"/>
    </marker>
  </defs>

  <!-- TITLE -->
  <text x="280" y="38" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="22" fill="#e0e0e0" font-weight="bold"
        transform="rotate(-0.4, 280, 38)">
    Learning Module Architecture
  </text>
  <path d="M 100,46 C 190,48 370,44 460,47"
        stroke="rgb(168,85,247)" stroke-width="1.5" fill="none"
        stroke-linecap="round" opacity="0.6"/>

  <!-- REGION LABEL: Agent Request -->
  <path d="M 86,58 C 88,56 92,55 96,56"
        stroke="#4a9eff" stroke-width="1.2" fill="none"
        stroke-linecap="round" opacity="0.5"/>
  <text x="92" y="73" text-anchor="start"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="#4a9eff" opacity="0.6">agent request</text>

  <!-- STAGE 1: Pre-Run Selection -->
  <g transform="rotate(-0.3, 300, 105)">
    <circle cx="108" cy="82" r="14" fill="rgb(168,85,247)" stroke="none" opacity="0.9"/>
    <text x="108" y="87" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="14" fill="white" font-weight="bold">1</text>
    <path d="M 132,70 C 230,67 400,73 502,69
             C 505,85 503,105 505,128
             C 400,131 230,127 132,131
             C 129,110 131,88 129,70"
          stroke="rgb(168,85,247)" stroke-width="2" fill="rgba(168,85,247,0.08)"
          stroke-linecap="round" stroke-linejoin="round"/>
    <text x="318" y="92" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="15" fill="#e0e0e0" font-weight="bold">Pre-Run Selection</text>
    <text x="318" y="114" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="12" fill="#888888">pick arms to include in this request</text>
  </g>

  <path d="M 300,134 C 302,150 298,162 300,176"
        stroke="#e0e0e0" stroke-width="2" fill="none"
        stroke-linecap="round" marker-end="url(#arr)"/>

  <!-- STAGE 2: Thompson Sampling (CORE, glow) -->
  <g transform="rotate(0.5, 300, 220)" filter="url(#glow)">
    <circle cx="108" cy="192" r="14" fill="rgb(168,85,247)" stroke="none" opacity="0.9"/>
    <text x="108" y="197" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="14" fill="white" font-weight="bold">2</text>
    <path d="M 132,180 C 230,177 400,183 502,179
             C 505,198 503,224 505,248
             C 400,251 230,247 132,251
             C 129,228 131,200 129,180"
          stroke="rgb(168,85,247)" stroke-width="2.5" fill="rgba(168,85,247,0.12)"
          stroke-linecap="round" stroke-linejoin="round"/>
    <text x="318" y="206" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="15" fill="#e0e0e0" font-weight="bold">Thompson Sampling</text>
    <text x="318" y="228" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="12" fill="#888888">sample from Beta posteriors, rank arms</text>
    <text x="318" y="244" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="11" fill="rgb(168,85,247)" opacity="0.8">(Bayesian bandit)</text>
  </g>

  <path d="M 300,254 C 302,270 298,282 300,296"
        stroke="#e0e0e0" stroke-width="2" fill="none"
        stroke-linecap="round" marker-end="url(#arr)"/>

  <!-- STAGE 3: Prompt Assembly -->
  <g transform="rotate(-0.4, 300, 330)">
    <circle cx="108" cy="312" r="14" fill="rgb(168,85,247)" stroke="none" opacity="0.9"/>
    <text x="108" y="317" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="14" fill="white" font-weight="bold">3</text>
    <path d="M 132,300 C 230,297 400,303 502,299
             C 505,318 503,344 505,368
             C 400,371 230,367 132,371
             C 129,348 131,320 129,300"
          stroke="rgb(168,85,247)" stroke-width="2" fill="rgba(168,85,247,0.08)"
          stroke-linecap="round" stroke-linejoin="round"/>
    <text x="318" y="326" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="15" fill="#e0e0e0" font-weight="bold">Prompt Assembly</text>
    <text x="318" y="348" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="12" fill="#888888">build final prompt with selected arms</text>
  </g>

  <!-- REGION LABEL: Post-Run Feedback -->
  <path d="M 86,388 C 88,386 92,385 96,386"
        stroke="#ff6b6b" stroke-width="1.2" fill="none"
        stroke-linecap="round" opacity="0.5"/>
  <text x="92" y="403" text-anchor="start"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="#ff6b6b" opacity="0.6">post-run feedback</text>

  <path d="M 300,374 C 302,390 298,402 300,416"
        stroke="#e0e0e0" stroke-width="2" fill="none"
        stroke-linecap="round" marker-end="url(#arr)"/>

  <!-- STAGE 4: Reference Detection -->
  <g transform="rotate(0.3, 300, 450)">
    <circle cx="108" cy="432" r="14" fill="rgb(168,85,247)" stroke="none" opacity="0.9"/>
    <text x="108" y="437" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="14" fill="white" font-weight="bold">4</text>
    <path d="M 132,420 C 230,417 400,423 502,419
             C 505,438 503,464 505,488
             C 400,491 230,487 132,491
             C 129,468 131,440 129,420"
          stroke="rgb(168,85,247)" stroke-width="2" fill="rgba(168,85,247,0.08)"
          stroke-linecap="round" stroke-linejoin="round"/>
    <text x="318" y="446" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="15" fill="#e0e0e0" font-weight="bold">Reference Detection</text>
    <text x="318" y="468" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="12" fill="#888888">trace which arms the model actually used</text>
  </g>

  <path d="M 300,494 C 302,510 298,522 300,536"
        stroke="#e0e0e0" stroke-width="2" fill="none"
        stroke-linecap="round" marker-end="url(#arr)"/>

  <!-- STAGE 5: Post-Run Update -->
  <g transform="rotate(-0.5, 300, 570)">
    <circle cx="108" cy="552" r="14" fill="rgb(168,85,247)" stroke="none" opacity="0.9"/>
    <text x="108" y="557" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="14" fill="white" font-weight="bold">5</text>
    <path d="M 132,540 C 230,537 400,543 502,539
             C 505,558 503,584 505,608
             C 400,611 230,607 132,611
             C 129,588 131,560 129,540"
          stroke="rgb(168,85,247)" stroke-width="2" fill="rgba(168,85,247,0.08)"
          stroke-linecap="round" stroke-linejoin="round"/>
    <text x="318" y="566" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="15" fill="#e0e0e0" font-weight="bold">Post-Run Update</text>
    <text x="318" y="588" text-anchor="middle"
          font-family="'Caveat', 'Comic Sans MS', cursive"
          font-size="12" fill="#888888">update Beta(&#x3B1;,&#x3B2;) posteriors in SQLite</text>
  </g>

  <!-- FEEDBACK LOOP: back to Pre-Run Selection -->
  <path d="M 508,575 C 540,575 558,560 562,520
           C 566,440 566,320 562,220
           C 558,140 540,105 510,100"
        stroke="rgb(168,85,247)" stroke-width="1.8" fill="none"
        stroke-linecap="round" stroke-dasharray="6 4"
        opacity="0.5" marker-end="url(#arr-purple)"/>
  <text x="576" y="340" text-anchor="start"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="rgb(168,85,247)" opacity="0.6"
        transform="rotate(90, 576, 340)">feedback loop</text>

  <!-- OBSERVABILITY SIDE PANEL -->
  <text x="42" y="510" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="12" fill="#4ade80" opacity="0.7">observability</text>
  <path d="M 14,520 C 16,518 66,518 70,520
           C 72,540 72,620 70,640
           C 66,642 16,642 14,640
           C 12,620 12,540 14,520"
        stroke="#4ade80" stroke-width="1.2" fill="rgba(74,222,128,0.06)"
        stroke-linecap="round" stroke-linejoin="round" opacity="0.6"/>
  <text x="42" y="540" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="#888888">CLI</text>
  <text x="42" y="565" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="#888888">Dashboard</text>
  <text x="42" y="590" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="#888888">REST API</text>
  <text x="42" y="615" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="11" fill="#888888">Export</text>

  <!-- dashed line from observability to stage 5 -->
  <path d="M 74,580 C 88,580 100,578 124,575"
        stroke="#888888" stroke-width="1" fill="none"
        stroke-linecap="round" stroke-dasharray="3 3"
        opacity="0.4"/>

  <!-- BOTTOM CAPTION -->
  <text x="300" y="660" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="13" fill="#888888" opacity="0.7"
        transform="rotate(-0.3, 300, 660)">
    Bayesian bandit loop: select &#x2192; assemble &#x2192; run &#x2192; trace &#x2192; update posteriors &#x2192; repeat
  </text>

  <!-- FLOW HINT -->
  <text x="300" y="695" text-anchor="middle"
        font-family="'Caveat', 'Comic Sans MS', cursive"
        font-size="10" fill="#64748b" opacity="0.5">
    &#x2193; signal flow &#x2193;
  </text>
</svg>